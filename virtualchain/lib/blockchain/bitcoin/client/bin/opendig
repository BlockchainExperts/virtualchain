#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
	OpenDig
	~~~~~

	:copyright: (c) 2014 by OpenNameSystem.org
	:license: MIT, see LICENSE for more details.
"""

from cement.core import backend, foundation, controller, handler

import json
import sys

try:
	from opendig import dns_resolver, ons_resolver 
except:
	sys.stdout.write("ERROR: opendig is not installed. Try 'sudo pip install opendig'" + '\n')
	exit()

#----------------------------------------
# define an application base controller
class OpenDigController(controller.CementBaseController):
	class Meta:
		label = 'base'
		description = "OpenDig: Command-line client for ONS (http://OpenNameSystem.org)"

		config_defaults = dict(
			user = None,
			domain = None,
			)

		arguments = [
			(['-u', '--user'], dict(action='store', help='get user info')),
			(['-d', '--domain'], dict(action='store', help='get domain info'))
			]

	#----------------------------------------
	@controller.expose(hide=True, aliases=['run'])
	def default(self):
		
		if self.app.pargs.user:
		
			data = ons_resolver(self.app.pargs.user)
			sys.stdout.write(pretty_dump(data))

		elif self.app.pargs.domain:

			data = dns_resolver(self.app.pargs.domain)

			for reply in data.answer:
				sys.stdout.write(reply.to_text() + '\n')
		else: 
			sys.stdout.write("Try 'opendig -h' for help" + '\n')

	#----------------------------------------
	@controller.expose(help="get the twitter handle of a user")
	def twitter(self):
	
		if self.app.pargs.user:
			data = ons_resolver(self.app.pargs.user)

			if 'twitter' in data: 
				sys.stdout.write(pretty_dump(data['twitter']) + '\n')
			else:
				sys.stdout.write(pretty_dump({}) + '\n')
		else:
			sys.stdout.write("No user given. Try 'opendig twitter -u <username>'" + '\n')

	#----------------------------------------
	@controller.expose(help="get the github username of a user")
	def github(self):
		
		if self.app.pargs.user:
			data = ons_resolver(self.app.pargs.user)

			if 'github' in data: 
				sys.stdout.write(pretty_dump(data['github']) + '\n')
			else:
				sys.stdout.write(pretty_dump({}) + '\n')

		else:
			sys.stdout.write("No user given. Try 'opendig github -u <username>'" + '\n')

	#----------------------------------------
	@controller.expose(aliases=['btc'], help="get the bitcoin address of a user")
	def bitcoin(self):

		if self.app.pargs.user:
			data = ons_resolver(self.app.pargs.user)

			if 'bitcoin' in data: 
				sys.stdout.write(pretty_dump(data['bitcoin']) + '\n')
			else:
				sys.stdout.write(pretty_dump({}) + '\n')

		else:
			sys.stdout.write("No user given. Try 'opendig bitcoin -u <username>'" + '\n')

#----------------------------------------
class OpenDigApp(foundation.CementApp):
	class Meta:
		label = 'OpenDig'
		base_controller = OpenDigController

#----------------------------------------
# create the app
app = OpenDigApp()

#-------------------------
def pretty_dump(input):

    return json.dumps(input, sort_keys=False, indent=4, separators=(',', ': '))

	
#----------------------------------------
if __name__ == '__main__':


	try:
		# setup the application
		app.setup()

		# run the application
		app.run()
	finally:
		# close the app
		app.close()